/*******************************************************************************
* OBSERVATION_RAW
* 
* Description: This query combines observation data from multiple staging tables
* into a single comprehensive observation dataset following the OMOP CDM structure.
* It includes both standard OMOP fields and additional custom fields for tracking
* source data and ETL processes.
*******************************************************************************/
SELECT DISTINCT
    CARE_RES_OMOP_DEV2_WKSP.OMOP.OBSERVATION_RAW_SEQ.nextval::NUMBER(28,0)    AS OBSERVATION_ID
    , PERSON_ID::NUMBER(28,0)                     AS PERSON_ID
    , OBSERVATION_CONCEPT_ID::NUMBER(28,0)        AS OBSERVATION_CONCEPT_ID
    , OBSERVATION_DATE::DATE                      AS OBSERVATION_DATE
    , OBSERVATION_DATETIME::DATETIME              AS OBSERVATION_DATETIME
    , OBSERVATION_TYPE_CONCEPT_ID::NUMBER(28,0)   AS OBSERVATION_TYPE_CONCEPT_ID
    , VALUE_AS_NUMBER::FLOAT                      AS VALUE_AS_NUMBER
    , VALUE_AS_STRING::VARCHAR(60)                AS VALUE_AS_STRING
    , VALUE_AS_CONCEPT_ID::NUMBER(28,0)           AS VALUE_AS_CONCEPT_ID
    , UNIT_CONCEPT_ID::NUMBER(28,0)               AS UNIT_CONCEPT_ID
    , QUALIFIER_CONCEPT_ID::NUMBER(28,0)          AS QUALIFIER_CONCEPT_ID
    , PROVIDER_ID::NUMBER(28,0)                   AS PROVIDER_ID
    , VISIT_OCCURRENCE_ID::NUMBER(28,0)           AS VISIT_OCCURRENCE_ID
    , VISIT_DETAIL_ID::NUMBER(28,0)               AS VISIT_DETAIL_ID
    , OBSERVATION_SOURCE_VALUE::VARCHAR(50)       AS OBSERVATION_SOURCE_VALUE --Human readable Source Value use src_VALUE_ID below to link
    , OBSERVATION_SOURCE_CONCEPT_ID::NUMBER(28,0) AS OBSERVATION_SOURCE_CONCEPT_ID
    , UNIT_SOURCE_VALUE::VARCHAR(50)              AS UNIT_SOURCE_VALUE
    , QUALIFIER_SOURCE_VALUE::VARCHAR(50)         AS QUALIFIER_SOURCE_VALUE
    , VALUE_SOURCE_VALUE::VARCHAR(50)             AS VALUE_SOURCE_VALUE
    , OBSERVATION_EVENT_ID::NUMBER(28,0)          AS OBSERVATION_EVENT_ID
    , OBS_EVENT_FIELD_CONCEPT_ID::NUMBER(28,0)    AS OBS_EVENT_FIELD_CONCEPT_ID

 ------Non OMOP fields -----------
    , ETL_MODULE::VARCHAR                         AS etl_MODULE
    , STAGE_PAT_ID::VARCHAR                  	  AS phi_PAT_ID
    , STAGE_MRN_CPI::NUMBER(28,0)                 AS phi_MRN_CPI
    , STAGE_CSN_ID::NUMBER(28,0)			      AS phi_CSN_ID
----- Link to source
    , SRC_TABLE::VARCHAR                          AS src_TABLE
    , SRC_FIELD::VARCHAR                          AS src_FIELD
    , SRC_VALUE_ID::VARCHAR                       AS src_VALUE_ID

FROM
    -- Ambulatory ICD Observations
(
    SELECT PERSON_ID, OBSERVATION_CONCEPT_ID, OBSERVATION_DATE, OBSERVATION_DATETIME, OBSERVATION_TYPE_CONCEPT_ID,
    VALUE_AS_NUMBER, VALUE_AS_STRING, VALUE_AS_CONCEPT_ID, UNIT_CONCEPT_ID, QUALIFIER_CONCEPT_ID, PROVIDER_ID,
    VISIT_OCCURRENCE_ID, VISIT_DETAIL_ID, OBSERVATION_SOURCE_VALUE, OBSERVATION_SOURCE_CONCEPT_ID, UNIT_SOURCE_VALUE, QUALIFIER_SOURCE_VALUE,
    VALUE_SOURCE_VALUE, OBSERVATION_EVENT_ID, OBS_EVENT_FIELD_CONCEPT_ID,
    ETL_MODULE, STAGE_PAT_ID, STAGE_MRN_CPI, STAGE_CSN_ID,
    'CLARITY_EDG' as SRC_TABLE, 'DX_ID' AS SRC_FIELD, STAGE_DX_ID::INTEGER AS SRC_VALUE_ID
FROM
     CARE_RES_OMOP_DEV2_WKSP.OMOP_STAGE.STAGE_OBSERVATION_AMB_ICD  AS STAGE_OBSERVATION_AMB_ICD
UNION ALL
    -- Hospital ICD Observations
SELECT PERSON_ID, OBSERVATION_CONCEPT_ID, OBSERVATION_DATE, OBSERVATION_DATETIME, OBSERVATION_TYPE_CONCEPT_ID,
    VALUE_AS_NUMBER, VALUE_AS_STRING, VALUE_AS_CONCEPT_ID, UNIT_CONCEPT_ID, QUALIFIER_CONCEPT_ID, PROVIDER_ID,
    VISIT_OCCURRENCE_ID, VISIT_DETAIL_ID, OBSERVATION_SOURCE_VALUE, OBSERVATION_SOURCE_CONCEPT_ID, UNIT_SOURCE_VALUE, QUALIFIER_SOURCE_VALUE,
    VALUE_SOURCE_VALUE, OBSERVATION_EVENT_ID, OBS_EVENT_FIELD_CONCEPT_ID,
    ETL_MODULE, STAGE_PAT_ID, STAGE_MRN_CPI, STAGE_CSN_ID,
    'CLARITY_EDG' as SRC_TABLE, 'DX_ID' AS SRC_FIELD, STAGE_DX_ID::INTEGER AS SRC_VALUE_ID
FROM
     CARE_RES_OMOP_DEV2_WKSP.OMOP_STAGE.STAGE_OBSERVATION_HSP_ICD AS STAGE_OBSERVATION_HSP_ICD
UNION ALL
    -- Allergy Observations
SELECT PERSON_ID, OBSERVATION_CONCEPT_ID, OBSERVATION_DATE, OBSERVATION_DATETIME, OBSERVATION_TYPE_CONCEPT_ID,
    VALUE_AS_NUMBER, VALUE_AS_STRING, VALUE_AS_CONCEPT_ID, UNIT_CONCEPT_ID, QUALIFIER_CONCEPT_ID, PROVIDER_ID,
    VISIT_OCCURRENCE_ID, VISIT_DETAIL_ID, OBSERVATION_SOURCE_VALUE, OBSERVATION_SOURCE_CONCEPT_ID, UNIT_SOURCE_VALUE, QUALIFIER_SOURCE_VALUE,
    VALUE_SOURCE_VALUE, OBSERVATION_EVENT_ID, OBS_EVENT_FIELD_CONCEPT_ID,
    ETL_MODULE, STAGE_PAT_ID, STAGE_MRN_CPI, STAGE_CSN_ID,
    'ALLERGY' as SRC_TABLE, 'ALLERGY_ID' AS SRC_FIELD, STAGE_ALLERGY_ID::INTEGER AS SRC_VALUE_ID
FROM
     CARE_RES_OMOP_DEV2_WKSP.OMOP_STAGE.STAGE_OBSERVATION_ALLERGY_ALL AS STAGE_OBSERVATION_ALLERGY_ALL
UNION ALL
    -- Hospital SDOH Flowsheet Observations
SELECT PERSON_ID, OBSERVATION_CONCEPT_ID, OBSERVATION_DATE, OBSERVATION_DATETIME, OBSERVATION_TYPE_CONCEPT_ID,
    VALUE_AS_NUMBER, VALUE_AS_STRING, VALUE_AS_CONCEPT_ID, UNIT_CONCEPT_ID, QUALIFIER_CONCEPT_ID, PROVIDER_ID,
    VISIT_OCCURRENCE_ID, VISIT_DETAIL_ID, OBSERVATION_SOURCE_VALUE, OBSERVATION_SOURCE_CONCEPT_ID, UNIT_SOURCE_VALUE, QUALIFIER_SOURCE_VALUE,
    VALUE_SOURCE_VALUE, OBSERVATION_EVENT_ID, OBS_EVENT_FIELD_CONCEPT_ID,
    ETL_MODULE, STAGE_PAT_ID, STAGE_MRN_CPI, STAGE_CSN_ID,
    'IP_FLO_GP_DATA' as SRC_TABLE, 'FLO_MEAS_ID' AS SRC_FIELD, STAGE_FLO_MEAS_ID::INTEGER AS SRC_VALUE_ID
FROM
     CARE_RES_OMOP_DEV2_WKSP.OMOP_STAGE.STAGE_OBSERVATION_HSP_SDOH_FLOWSHEET AS STAGE_OBSERVATION_HSP_SDOH_FLOWSHEET
UNION ALL
    -- Ambulatory SDOH Flowsheet Observations
SELECT PERSON_ID, OBSERVATION_CONCEPT_ID, OBSERVATION_DATE, OBSERVATION_DATETIME, OBSERVATION_TYPE_CONCEPT_ID,
    VALUE_AS_NUMBER, VALUE_AS_STRING, VALUE_AS_CONCEPT_ID, UNIT_CONCEPT_ID, QUALIFIER_CONCEPT_ID, PROVIDER_ID,
    VISIT_OCCURRENCE_ID, VISIT_DETAIL_ID, OBSERVATION_SOURCE_VALUE, OBSERVATION_SOURCE_CONCEPT_ID, UNIT_SOURCE_VALUE, QUALIFIER_SOURCE_VALUE,
    VALUE_SOURCE_VALUE, OBSERVATION_EVENT_ID, OBS_EVENT_FIELD_CONCEPT_ID,
    ETL_MODULE, STAGE_PAT_ID, STAGE_MRN_CPI, STAGE_CSN_ID,
    'IP_FLO_GP_DATA' as SRC_TABLE, 'FLO_MEAS_ID' AS SRC_FIELD, STAGE_FLO_MEAS_ID::INTEGER AS SRC_VALUE_ID
FROM
     CARE_RES_OMOP_DEV2_WKSP.OMOP_STAGE.STAGE_OBSERVATION_AMB_SDOH_FLOWSHEET AS STAGE_OBSERVATION_AMB_SDOH_FLOWSHEET
) AS A