
--PULL_CONDITION_OCCURRENCE_AMB_ICD
{#-- {{ config(materialized = 'view', schema = 'OMOP_PULL') }}#}

SELECT DISTINCT
-- ***STAGE ATTRIBUTES***
-- fields used for the Stage
    PULL_VISIT_OCCURRENCE_AMB.PERSON_ID                             AS PERSON_ID
    ,PULL_VISIT_OCCURRENCE_AMB.VISIT_START_DATETIME :: DATE         AS CONDITION_START_DATE
    ,PULL_VISIT_OCCURRENCE_AMB.VISIT_START_DATETIME                 AS CONDITION_START_DATETIME
    ,PULL_VISIT_OCCURRENCE_AMB.VISIT_END_DATETIME :: DATE 	        AS CONDITION_END_DATE
	,PULL_VISIT_OCCURRENCE_AMB.VISIT_END_DATETIME 					AS CONDITION_END_DATETIME
    ,PULL_VISIT_OCCURRENCE_AMB.PULL_PROVIDER_SOURCE_VALUE           AS PROVIDER_SOURCE_VALUE

-- ***ADDITIONAL ATTRIBUTES***
-- Non-OMOP fields used for the Stage
    ,PULL_VISIT_OCCURRENCE_AMB.PULL_CSN_ID                          AS PULL_CSN_ID
    ,PULL_VISIT_OCCURRENCE_AMB.VISIT_START_DATE                     AS PULL_VISIT_DATE
    ,T_DIAGNOSIS.DX_ID                                              AS PULL_DX_ID
    ,T_DIAGNOSIS.DX_NAME                                            AS PULL_DX_NAME
    ,T_DIAGNOSIS.ICD10_CODE                                         AS PULL_ICD10_CODE
    ,T_DIAGNOSIS.ICD9_CODE                                          AS PULL_ICD9_CODE

-- ***PULL attributes***
-- field names pulled from the source for verification purposes. May be duplicated above.
/*	,PULL_VISIT_OCCURRENCE_AMB.EHR_PATIENT_ID
    ,PULL_VISIT_OCCURRENCE_AMB.PAT_ID
    ,PULL_VISIT_OCCURRENCE_AMB.HSP_ACCOUNT_ID
    ,PULL_VISIT_OCCURRENCE_AMB.IP_DOC_CONTACT_CSN
    ,PULL_VISIT_OCCURRENCE_AMB.ENC_TYPE_C
    ,PULL_VISIT_OCCURRENCE_AMB.ZC_DISP_ENC_TYPE_NAME
    ,PULL_VISIT_OCCURRENCE_AMB.PAT_OR_ADM_LINK_CSN  AS PAT_OR_ADM_LINK_PAT_ENC_CSN_ID
    ,PULL_VISIT_OCCURRENCE_AMB.VISIT_PROV_ID
    ,VISIT_PROVIDER_NAME
    ,VISIT_PROVIDER_TYPE
    ,PULL_VISIT_OCCURRENCE_AMB.PCP_PROV_ID
    ,PCP_PROVIDER_NAME
    ,PCP_PROVIDER_TYPE
    ,PRIMARY_DX_YN

    ,'PULL_CONDITION_OCCURRENCE_CLARITYAMB_ICD' AS ETL_MODULE
*/

FROM  {{ ref('PAT_ENC_DX_stg')}} AS PAT_ENC_DX

INNER JOIN  {{ref('PULL_VISIT_OCCURRENCE_AMB')}} AS PULL_VISIT_OCCURRENCE_AMB
--    ON PAT_ENC_DX.PAT_ENC_CSN_ID = PULL_VISIT_OCCURRENCE_AMB.VISIT_SOURCE_VALUE
    ON PAT_ENC_DX.PAT_ENC_CSN_ID = PULL_VISIT_OCCURRENCE_AMB.PULL_CSN_ID
INNER JOIN  {{ref('T_DIAGNOSIS')}} AS T_DIAGNOSIS
    ON PAT_ENC_DX.DX_ID = T_DIAGNOSIS.DX_ID

WHERE PULL_VISIT_OCCURRENCE_AMB.PULL_ENC_TYPE_C <> 3 --Hospital Encounter
