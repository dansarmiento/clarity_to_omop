--STAGE_CONDITION_OCCURRENCE_AMB
{#-- {{ config(materialized = 'view', schema = 'OMOP_STAGE') }}#}

SELECT DISTINCT
	PULL_CONDITION_OCCURRENCE_AMB_ICD.PERSON_ID							AS PERSON_ID
	,CASE
		WHEN PULL_CONDITION_OCCURRENCE_AMB_ICD.CONDITION_START_DATE :: DATE >= '2015-10-01'
			THEN T_ICD10_CONCEPT.CONCEPT_ID
		ELSE T_ICD9_CONCEPT.CONCEPT_ID
		END 															AS CONDITION_CONCEPT_ID
	,PULL_CONDITION_OCCURRENCE_AMB_ICD.CONDITION_START_DATE 			AS CONDITION_START_DATE
	,PULL_CONDITION_OCCURRENCE_AMB_ICD.CONDITION_START_DATETIME 		AS CONDITION_START_DATETIME
	,PULL_CONDITION_OCCURRENCE_AMB_ICD.CONDITION_END_DATE  				AS CONDITION_END_DATE
	,PULL_CONDITION_OCCURRENCE_AMB_ICD.CONDITION_END_DATETIME 			AS CONDITION_END_DATETIME
	,32817 																AS CONDITION_TYPE_CONCEPT_ID
	,NULL 																AS STOP_REASON
	,PROVIDER.PROVIDER_ID 												AS PROVIDER_ID
    ,VISIT_OCCURRENCE.VISIT_OCCURRENCE_ID 								AS VISIT_OCCURRENCE_ID
    ,NULL 																	AS VISIT_DETAIL_ID
	-- RETURNS ICD10 CODES AFTER SWITCH DATE-----
	,CASE
		WHEN PULL_CONDITION_OCCURRENCE_AMB_ICD.PULL_VISIT_DATE >= '2015-10-01'
			THEN LEFT(T_ICD10_SOURCE.CONCEPT_CODE || ':' || T_ICD10_SOURCE.CONCEPT_NAME, 50)
		ELSE LEFT(T_ICD9_SOURCE.CONCEPT_CODE || ':' || T_ICD9_SOURCE.CONCEPT_NAME, 50)
		END 															AS CONDITION_SOURCE_VALUE
	,CASE
		WHEN PULL_CONDITION_OCCURRENCE_AMB_ICD.PULL_VISIT_DATE >= '2015-10-01'
			THEN T_ICD10_SOURCE.CONCEPT_ID
		ELSE T_ICD9_SOURCE.CONCEPT_ID
		END 															AS CONDITION_SOURCE_CONCEPT_ID
	--------------------------------------------
	,'FINAL DIAGNOSIS' 													AS CONDITION_STATUS_SOURCE_VALUE
	,32896 															AS CONDITION_STATUS_CONCEPT_ID
	-------- Non-OMOP Fields ------------
	, 'STAGE_CONDITION_OCCURRENCE_AMB' 									AS ETL_MODULE
	, VISIT_OCCURRENCE.phi_PAT_ID                      					AS STAGE_PAT_ID
    , VISIT_OCCURRENCE.phi_MRN_CPI                           			AS STAGE_MRN_CPI
	, VISIT_OCCURRENCE.phi_CSN_ID										AS STAGE_CSN_ID
    , PULL_DX_ID                                                        AS STAGE_DX_ID

FROM {{ref('PULL_CONDITION_OCCURRENCE_AMB_ICD')}} AS PULL_CONDITION_OCCURRENCE_AMB_ICD

	INNER JOIN {{ref('VISIT_OCCURRENCE_RAW')}} AS VISIT_OCCURRENCE
		ON PULL_CONDITION_OCCURRENCE_AMB_ICD.PULL_CSN_ID = VISIT_OCCURRENCE.phi_CSN_ID

    LEFT JOIN  {{ref('PROVIDER_RAW')}} AS PROVIDER
        ON  PULL_CONDITION_OCCURRENCE_AMB_ICD.PROVIDER_SOURCE_VALUE = PROVIDER.PROVIDER_SOURCE_VALUE

	--------CONCEPT MAPPING--------------------
	LEFT JOIN {{ref('T_ICD_SOURCE')}} AS T_ICD9_SOURCE
		ON PULL_CONDITION_OCCURRENCE_AMB_ICD.PULL_ICD9_CODE = T_ICD9_SOURCE.CONCEPT_CODE

	LEFT JOIN {{ref('T_ICD_SOURCE')}} AS T_ICD10_SOURCE
		ON PULL_CONDITION_OCCURRENCE_AMB_ICD.PULL_ICD10_CODE = T_ICD10_SOURCE.CONCEPT_CODE

	LEFT JOIN {{ref('T_CONDITION_CONCEPT')}} AS  T_ICD9_CONCEPT
		ON T_ICD9_CONCEPT.SOURCE_CONCEPT_ID = T_ICD9_SOURCE.CONCEPT_ID

	LEFT JOIN {{ref('T_CONDITION_CONCEPT')}} AS  T_ICD10_CONCEPT
		ON T_ICD10_CONCEPT.SOURCE_CONCEPT_ID = T_ICD10_SOURCE.CONCEPT_ID

WHERE
	(PULL_CONDITION_OCCURRENCE_AMB_ICD.PULL_VISIT_DATE >= '2015-10-01' AND T_ICD10_CONCEPT.CONCEPT_ID IS NOT NULL)
	OR
	(PULL_CONDITION_OCCURRENCE_AMB_ICD.PULL_VISIT_DATE < '2015-10-01' AND T_ICD9_CONCEPT.CONCEPT_ID IS NOT NULL)

